# Qwen Planning + AgentCortex Execution Hybrid

## Overview

This hybrid approach combines **Qwen LLM for planning** with **AgentCortex execution services** to generate training data for the planning agent while leveraging the real Lenovo AgentCortex infrastructure.

## Architecture

```
User Query â†’ Qwen LLM â†’ Plan Objects â†’ AgentCortex Execution â†’ Results
    â†‘            â†“                          â†“                    â†“
Planning      Function               Tool Execution         Training
Module        Calls                  Service                Data
```

## Key Components

### 1. **Qwen Planning Module**
- Uses your existing Qwen LLM setup for intelligent planning
- Generates function calls based on user queries and available tools
- Converts OpenAI-style function calls to AgentCortex Plan objects
- Provides realistic planning behavior for training data generation

### 2. **AgentCortex Execution Module** 
- Uses the real Lenovo AgentCortex execution service
- Processes Plan objects and executes tools via microservice architecture
- Returns actual Lenovo service data (products, orders, user info, etc.)
- Maintains compatibility with existing AgentCortex infrastructure

### 3. **Plan Object Conversion**
- Automatically converts Qwen's function call format to AgentCortex Plan format
- Preserves tool names, arguments, and execution context
- Enables seamless integration between planning and execution phases

## Benefits

âœ… **Training Data Generation**: Qwen generates diverse and realistic plans for training the AgentCortex planning service

âœ… **Real Service Integration**: Uses actual AgentCortex execution infrastructure for authentic results

âœ… **No MCP Fallback**: Completely removes MCP dependencies and uses only AgentCortex services

âœ… **Planning Agent Training**: Creates high-quality training examples showing how queries should be converted to plans

âœ… **Production Compatibility**: Generated data matches the exact format expected by AgentCortex production systems

## Usage

### Configuration

The hybrid approach is automatically used when:
1. `AGENTCORTEX_ENABLED=true` in your environment
2. AgentCortex services are running and accessible
3. Qwen LLM is configured in your `config.py`

### Running the Pipeline

```bash
# Standard pipeline run (now uses hybrid approach)
python run_pipeline.py

# Test the hybrid approach specifically
python test_qwen_agentcortex_hybrid.py
```

### Expected Output

```
ðŸ§  Using Qwen Planning + AgentCortex Execution (training data generation)
ðŸ§  Using Qwen LLM for planning...
ðŸ”§ Qwen planned function call, converting to Plan object...
âš¡ Executing via AgentCortex execution service...
âœ… Function execution completed via AgentCortex
```

## Code Flow

1. **User Query Processing**: Extract user intent from conversation history
2. **Qwen Planning**: Send query + tools to Qwen LLM for function call generation
3. **Plan Conversion**: Convert Qwen function calls to AgentCortex Plan objects
4. **AgentCortex Execution**: Execute Plan via real AgentCortex execution service
5. **Result Integration**: Return results in trajectory collection format
6. **Training Data**: Complete trajectory becomes training data for planning agent

## Modified Components

### `PlanExecuteAgent` (`core/agentcortex/plan_execute_agent.py`)
- Replaced AgentCortex Planning service with direct Qwen LLM calls
- Added Plan object conversion logic
- Maintained AgentCortex execution service integration
- Preserved trajectory collection interface

### `TrajectoryCollector` (`core/trajectory/pipeline.py`)
- Updated to indicate hybrid approach in logging
- No interface changes - drop-in replacement for existing flow

## Key Features

- **Qwen Intelligence**: Uses your fine-tuned Qwen model's planning capabilities
- **AgentCortex Reality**: Executes tools using real Lenovo microservices
- **Training Focus**: Generates data specifically for training the planning agent
- **Service Authenticity**: All tool results come from actual AgentCortex services
- **Format Consistency**: Output matches AgentCortex planning service format exactly

## Testing

Run the test script to verify the hybrid approach:

```bash
python test_qwen_agentcortex_hybrid.py
```

This will test:
- Qwen LLM planning with function calls
- Plan object conversion 
- AgentCortex execution service integration
- End-to-end trajectory flow
- Training data generation format

## Training Data Output

The generated trajectories will contain:
- **User Queries**: Natural language requests
- **Qwen Plans**: Function calls generated by your Qwen model
- **AgentCortex Results**: Real tool execution results from Lenovo services
- **Complete Context**: Full conversation flows for training

This data can be used to train the AgentCortex planning service to replicate Qwen's planning behavior while understanding the context of real Lenovo service execution results. 